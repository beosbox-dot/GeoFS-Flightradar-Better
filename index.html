<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AeroPulse - Flight Plan + Multiplayer</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
:root {
    --accent:#2ca1ff;
    --bg-dark:#0e0f12;
    --bg-sidebar:rgba(22,24,28,0.75);
    --text-light:#ddd;
    --text-dim:#aaa;
}

/* Reset */
body, html {margin:0;padding:0;font-family:'Segoe UI',sans-serif;background:var(--bg-dark);color:var(--text-light);}

/* Sidebar */
#sidebar {
    width:270px;height:100vh;background:var(--bg-sidebar);
    backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
    border-right:1px solid rgba(255,255,255,0.1);
    display:flex;flex-direction:column;
    box-shadow:3px 0 20px rgba(0,0,0,0.6);
    position:fixed;z-index:1000;transition:all 0.3s ease;
}
#sidebar h1{font-size:22px;font-weight:600;color:var(--accent);text-align:center;margin:24px 0;}
#sidebar button{padding:14px 24px;background: rgba(255,255,255,0.05);border:none;color:var(--text-light);text-align:left;font-size:15px;cursor:pointer;border-radius:8px;margin:4px 12px;transition:all 0.2s ease;}
#sidebar button:hover{background: rgba(44,161,255,0.2); color: var(--accent); transform: translateX(4px);}
#userInfo{margin-top:auto;padding:20px;font-size:14px;border-top:1px solid rgba(255,255,255,0.1);color:var(--text-dim);}

/* Map */
#map {position:absolute; left:270px; top:0; right:0; bottom:0; z-index:0;}

/* Form */
#formContainer {display:none;position:absolute;top:0;left:270px;width:calc(100%-270px);height:100vh;background:rgba(27,29,34,0.75);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);padding:40px;color:var(--text-light);overflow-y:auto;z-index:1000;border-left:1px solid rgba(255,255,255,0.1);}
#flightForm { max-width:500px;margin:0 auto;}
#flightForm h2{color:var(--accent);font-weight:600;margin-bottom:20px;text-align:center;}
#flightForm label{display:block;margin-top:12px;font-size:14px;color:var(--text-dim);}
#flightForm input{width:100%;padding:10px;border:1px solid rgba(255,255,255,0.2);border-radius:6px;background:rgba(18,20,23,0.5);color:var(--text-light);margin-top:4px;font-size:14px;transition:all 0.2s ease;}
#flightForm input:hover,#flightForm input:focus{background:rgba(18,20,23,0.8);border-color:var(--accent);}
#flightForm button{background:var(--accent);color:#fff;padding:12px;border:none;border-radius:6px;width:100%;margin-top:16px;font-size:15px;cursor:pointer;transition:background 0.2s,transform 0.2s;}
#flightForm button:hover{background:#1082e0;transform:translateY(-2px);}
</style>
</head>
<body>
<div id="sidebar">
    <h1>AeroPulse</h1>
    <button onclick="showSection('home')">Home</button>
    <button onclick="showSection('newFlight')">New Flight</button>
    <button onclick="showSection('traffic')">ADS-B Traffic</button>
    <div id="userInfo">Not logged in</div>
</div>

<div id="map"></div>

<div id="formContainer">
    <form id="flightForm">
        <h2>Upload Flight Plan (.json)</h2>
        <label>Flight Plan JSON</label>
        <input type="file" id="flightFile" accept=".json" required>
        <button type="submit">Load Flight</button>
    </form>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ===== Map setup =====
const map = L.map('map',{ minZoom:3, maxZoom:15, zoomControl:true }).setView([10,105],5);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{ attribution:'&copy; OpenStreetMap, CARTO', subdomains:'abcd', maxZoom:19 }).addTo(map);

// ===== Flight plan =====
let flightLayer = null;
document.getElementById('flightForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const file = document.getElementById('flightFile').files[0];
    if(!file) return alert("Select JSON");
    const content = await file.text();
    const plan = JSON.parse(content);
    if(!plan.route||plan.route.length<2) return alert("Need 2+ coordinates");
    if(flightLayer) map.removeLayer(flightLayer);
    flightLayer = L.polyline(plan.route,{color:'#2ca1ff',weight:4,opacity:0.9,dashArray:'8,6'}).addTo(map);
    flightLayer.bindPopup(`<b>Flight:</b>${plan.flightNumber||'N/A'}<br><b>Aircraft:</b>${plan.aircraft||'N/A'}<br><b>Airline:</b>${plan.airline||'N/A'}`);
    map.fitBounds(flightLayer.getBounds(), {padding:[50,50], maxZoom:10});
});

// ===== Multiplayer hook =====
const players = {}; // id -> {marker, polyline, lastPos}

(function(){
    const OriginalWS = window.WebSocket;
    window.WebSocket = function(url,...args){
        const ws = new OriginalWS(url,...args);

        ws.addEventListener('message', e=>{
            try{
                const data = JSON.parse(e.data);
                // Example multiplayer data
                if(data.type==='players'){
                    data.players.forEach(p=>{
                        if(!players[p.id]){
                            const marker = L.circleMarker([p.lat,p.lng],{radius:6,color:'#ff4081'}).addTo(map);
                            const polyline = L.polyline([[p.lat,p.lng]],{color:'#ff4081',weight:2,opacity:0.8}).addTo(map);
                            marker.bindTooltip(`${p.flightNumber||'Unknown'} | ${p.aircraft||'N/A'} | ${Math.round(p.speed||0)}kt | ${Math.round(p.alt||0)}ft`);
                            players[p.id] = {marker, polyline, lastPos:[p.lat,p.lng]};
                        }else{
                            const pl = players[p.id];
                            pl.lastPos = [p.lat,p.lng];
                            pl.marker.setLatLng([p.lat,p.lng]);
                            pl.polyline.addLatLng([p.lat,p.lng]);
                            pl.marker.setTooltipContent(`${p.flightNumber||'Unknown'} | ${p.aircraft||'N/A'} | ${Math.round(p.speed||0)}kt | ${Math.round(p.alt||0)}ft`);
                        }
                    });
                }
            }catch(err){}
        });

        return ws;
    };
})();

// ===== Sidebar =====
function showSection(section){document.getElementById('formContainer').style.display = section==='newFlight'?'block':'none';}

// ===== Zoom bounds fix =====
function updateBounds(){
    const zoom = map.getZoom();
    if(zoom<=map.getMinZoom()){
        const padding = 5;
        const center = map.getCenter();
        const bounds = L.latLngBounds(
            [center.lat-padding,center.lng-padding],
            [center.lat+padding,center.lng+padding]
        );
        map.setMaxBounds(bounds);
    }else{
        map.setMaxBounds(null);
    }
}
map.on('zoomend', updateBounds);
map.on('moveend', updateBounds);
</script>
</body>
</html>
